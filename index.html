<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice AI Assistant</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --prm: #007bff; --bg: #f0f2f5; --card: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        .card { background: var(--card); padding: 25px; border-radius: 24px; box-shadow: 0 12px 40px rgba(0,0,0,0.12); width: 100%; max-width: 420px; text-align: center; }
        #mic-btn { width: 90px; height: 90px; border-radius: 50%; border: none; background: var(--prm); color: white; font-size: 35px; cursor: pointer; transition: all 0.3s ease; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,123,255,0.4); }
        #mic-btn.listening { background: #ff4757; transform: scale(1.15); animation: pulse 1.5s infinite; }
        .reminders-list { width: 100%; max-width: 420px; margin-top: 25px; }
        .item { background: white; margin: 12px 0; padding: 18px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--prm); animation: slideIn 0.3s ease; }
        .item.past { border-left-color: #ccc; opacity: 0.7; }
        button.del-btn { background: none; border: none; color: #ff4757; cursor: pointer; font-size: 18px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="card">
    <h2>–ú—ñ–π –ü–æ–º—ñ—á–Ω–∏–∫</h2>
    <p id="status">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω</p>
    <button id="mic-btn">üé§</button>
    <div id="output" style="min-height: 1.2em; color: #666; font-size: 0.9em;"></div>
</div>

<div class="reminders-list" id="list"></div>

<script>
// --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø (–í–°–¢–ê–í –°–í–û–á –î–ê–ù–Ü) ---
const TG_TOKEN = '–í–ê–®_BOT_TOKEN'; 
const TG_CHAT_ID = '–í–ê–®_CHAT_ID';

const btn = document.getElementById('mic-btn');
const status = document.getElementById('status');
const output = document.getElementById('output');
const listEl = document.getElementById('list');

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Speech
const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!Speech) alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏.");
const recognition = new Speech();
recognition.lang = 'uk-UA';
recognition.continuous = false;

// 1. –ì–û–õ–û–°–û–í–ï –í–í–ï–î–ï–ù–ù–Ø
btn.onclick = () => {
    try { recognition.start(); } catch(e) {}
};

recognition.onstart = () => {
    btn.classList.add('listening');
    status.innerText = "–Ø —Å–ª—É—Ö–∞—é...";
};

recognition.onresult = (e) => {
    btn.classList.remove('listening');
    const text = e.results[0][0].transcript.toLowerCase();
    output.innerText = `¬´${text}¬ª`;
    processText(text);
};

recognition.onend = () => btn.classList.remove('listening');

// 2. –°–ö–õ–ê–î–ù–ò–ô –ü–ê–†–°–ò–ù–ì –£–ö–†–ê–á–ù–°–¨–ö–û–á –ú–û–í–ò
function processText(text) {
    const now = new Date();
    let eventTime = new Date(now);
    
    // –®—É–∫–∞—î–º–æ —á–∞—Å (–Ω–∞–ø—Ä. 15:30 –∞–±–æ 10 00)
    const timeMatch = text.match(/(\d{1,2})[:.\s](\d{2})/);
    
    if (timeMatch) {
        eventTime.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0);
        
        // –Ø–∫—â–æ —á–∞—Å —É –º–∏–Ω—É–ª–æ–º—É ‚Äî –∑–Ω–∞—á–∏—Ç—å —Ü–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
        if (eventTime < now) eventTime.setDate(eventTime.getDate() + 1);
        
        // –û—á–∏—â–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –∑–∞–≤–¥–∞–Ω–Ω—è
        const task = text.replace(/–Ω–∞–≥–∞–¥–∞–π|–º–µ–Ω—ñ|–ø—Ä–æ|–æ|–≤|–Ω–∞|–∑–∞–ø–∏—à–∏/g, '').trim();
        saveReminder(task || "–ü–æ–¥—ñ—è", eventTime);
        
        speak(`–ó—Ä–æ–∑—É–º—ñ–≤. –ù–∞–≥–∞–¥–∞—é –ø—Ä–æ ${task || '–ø–æ–¥—ñ—é'} –æ ${timeMatch[1]} ${timeMatch[2]}`);
    } else {
        speak("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å —á–∞—Å, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –æ 10:30");
    }
}

// 3. –°–ò–ù–¢–ï–ó –ú–û–í–õ–ï–ù–ù–Ø (–£–ö–†–ê–á–ù–°–¨–ö–ò–ô –ì–û–õ–û–°)
function speak(msg) {
    const utter = new SpeechSynthesisUtterance(msg);
    utter.lang = 'uk-UA';
    // –ù–∞–º–∞–≥–∞—î–º–æ—Å—å –∑–Ω–∞–π—Ç–∏ –∂—ñ–Ω–æ—á–∏–π –≥–æ–ª–æ—Å, —è–∫—â–æ —î
    const voices = window.speechSynthesis.getVoices();
    const uaVoice = voices.find(v => v.lang.includes('UA'));
    if (uaVoice) utter.voice = uaVoice;
    window.speechSynthesis.speak(utter);
}

// 4. –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –¢–ê –¢–ï–õ–ï–ì–†–ê–ú
function saveReminder(task, time) {
    const reminders = JSON.parse(localStorage.getItem('voice_tasks') || '[]');
    const newEntry = {
        id: Date.now(),
        task: task,
        time: time.getTime(),
        done: [false, false, false] // 24–≥, 1–≥, 5—Ö–≤
    };
    reminders.push(newEntry);
    localStorage.setItem('voice_tasks', JSON.stringify(reminders));
    render();
}

async function notifyTelegram(msg) {
    try {
        await fetch(`https://api.telegram.org/bot${8586679119:AAGw0ifsSKupw1JFfG5Nz4P8pqkB8mEbLXE}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({chat_id: 1203975708, text: msg})
        });
    } catch(e) { console.error("TG Error", e); }
}

// 5. –¢–ê–ô–ú–ï–† –ü–ï–†–ï–í–Ü–†–ö–ò (–©–û–•–í–ò–õ–ò–ù–ò)
setInterval(() => {
    let tasks = JSON.parse(localStorage.getItem('voice_tasks') || '[]');
    const now = Date.now();
    let changed = false;

    tasks = tasks.filter(t => {
        const diff = t.time - now;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ–≤
        const intervals = [86400000, 3600000, 300000];
        const labels = ["–ó–∞ –¥–æ–±—É", "–ó–∞ –≥–æ–¥–∏–Ω—É", "–ó–∞ 5 —Ö–≤–∏–ª–∏–Ω"];

        intervals.forEach((ms, i) => {
            if (diff <= ms && diff > (ms - 60000) && !t.done[i]) {
                const msg = `‚è∞ ${labels[i]}: ${t.task}`;
                new Notification(msg);
                notifyTelegram(msg);
                t.done[i] = true;
                changed = true;
            }
        });

        // –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–ø–∏—Å–∏, —è–∫—ñ —Å—Ç–∞—Ä—ñ—à—ñ –∑–∞ 1 –≥–æ–¥–∏–Ω—É –≤—ñ–¥ —á–∞—Å—É –ø–æ–¥—ñ—ó
        return (now - t.time) < 3600000;
    });

    if (changed || true) { // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó —Å—Ç–∞—Ä–∏—Ö
        localStorage.setItem('voice_tasks', JSON.stringify(tasks));
        render();
    }
}, 30000);

function render() {
    const tasks = JSON.parse(localStorage.getItem('voice_tasks') || '[]');
    const listEl = document.getElementById('list'); // –ø–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ —Ü—è –∑–º—ñ–Ω–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
    
    listEl.innerHTML = tasks.sort((a, b) => a.time - b.time).map(t => `
        <div class="item ${t.time < Date.now() ? 'past' : ''}">
            <div>
                <strong>${t.task}</strong><br>
                <small>${new Date(t.time).toLocaleString('uk-UA')}</small>
            </div>
            <button class="del-btn" onclick="deleteTask(${t.id})">‚úï</button>
        </div>
    `).join('');
}

function deleteTask(id) {
    let tasks = JSON.parse(localStorage.getItem('voice_tasks') || '[]');
    tasks = tasks.filter(t => t.id !== id);
    localStorage.setItem('voice_tasks', JSON.stringify(tasks));
    render();
}

// SERVICE WORKER & PERMISSIONS
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
Notification.requestPermission();
render();
</script>
</body>

</html>
