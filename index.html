<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–∏–π –ü–æ–º—ñ—á–Ω–∏–∫</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --prm: #007bff; --bg: #f4f7f9; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        .card { background: var(--white); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
        #mic-btn { width: 90px; height: 90px; border-radius: 50%; border: none; background: var(--prm); color: white; font-size: 35px; cursor: pointer; margin: 20px 0; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,123,255,0.3); }
        #mic-btn.listening { background: #ff4757; animation: pulse 1s infinite; }
        .reminders-list { width: 100%; max-width: 400px; margin-top: 25px; }
        .item { background: var(--white); margin: 12px 0; padding: 18px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--prm); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .item strong { display: block; margin-bottom: 4px; }
        .item small { color: #888; }
        .del-btn { background: none; border: none; color: #ff4757; font-size: 22px; cursor: pointer; padding: 5px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="card">
        <h2>–ú—ñ–π –ü–æ–º—ñ—á–Ω–∏–∫</h2>
        <p id="status">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω —ñ –≥–æ–≤–æ—Ä—ñ—Ç—å</p>
        <button id="mic-btn">üé§</button>
        <div id="output" style="min-height: 1.5em; color: #666; font-style: italic; font-size: 0.9em;"></div>
    </div>

    <div class="reminders-list" id="list">
        </div>

<script>
// --- 1. –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
// –í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏ –≤–∞—à–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è, —è–∫–µ –≤–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –≤ Google Apps Script (–ø—ñ—Å–ª—è Deploy)
const googleBridgeUrl = "https://script.google.com/macros/s/AKfycbxiAdIfdtxjs4O2IFocMRpDoayHTYKGAiVZ9M9rGNi3bS6UY851OOmbX0IemTfPL8c/exec"; 

const btn = document.getElementById('mic-btn');
const status = document.getElementById('status');
const output = document.getElementById('output');
const listEl = document.getElementById('list');

// --- 2. –°–ò–ù–¢–ï–ó –ú–û–í–õ–ï–ù–ù–Ø (–£–ö–†–ê–á–ù–°–¨–ö–ê) ---
let ukVoice = null;
const loadVoices = () => {
    ukVoice = window.speechSynthesis.getVoices().find(v => v.lang.startsWith('uk'));
};
window.speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function speak(msg) {
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(msg);
    if (ukVoice) utter.voice = ukVoice;
    utter.lang = 'uk-UA';
    window.speechSynthesis.speak(utter);
}

// --- 3. –†–û–ó–ü–Ü–ó–ù–ê–í–ê–ù–ù–Ø –ú–û–í–ò ---
const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
if (Speech) {
    const recognition = new Speech();
    recognition.lang = 'uk-UA';
    recognition.continuous = false;

    btn.onclick = () => {
        try { recognition.start(); } catch(e) { console.warn("–í–∂–µ —Å–ª—É—Ö–∞—é"); }
    };

    recognition.onstart = () => {
        btn.classList.add('listening');
        status.innerText = "–Ø —Å–ª—É—Ö–∞—é...";
    };

    recognition.onend = () => {
        btn.classList.remove('listening');
        status.innerText = "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω";
    };

    recognition.onresult = (e) => {
        const text = e.results[0][0].transcript.toLowerCase();
        output.innerText = `¬´${text}¬ª`;
        processText(text);
    };
} else {
    status.innerText = "–ì–æ–ª–æ—Å–æ–≤–µ –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è";
}

// --- 4. –ü–ê–†–°–ò–ù–ì –¢–ê –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø ---
function processText(text) {
    const timeMatch = text.match(/(\d{1,2})[:.\s](\d{2})/);
    if (timeMatch) {
        const now = new Date();
        let evTime = new Date(now);
        evTime.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0);
        
        // –Ø–∫—â–æ —á–∞—Å –≤–∂–µ –º–∏–Ω—É–≤ —Å—å–æ–≥–æ–¥–Ω—ñ, —Å—Ç–∞–≤–∏–º–æ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
        if (evTime < now) evTime.setDate(evTime.getDate() + 1);
        
        const task = text.replace(/–Ω–∞–≥–∞–¥–∞–π|–º–µ–Ω—ñ|–ø—Ä–æ|–æ|–≤|–Ω–∞|–∑–∞–ø–∏—à–∏/g, '').trim() || "–ü–æ–¥—ñ—è";
        
        const tasks = JSON.parse(localStorage.getItem('v_tasks') || '[]');
        tasks.push({
            id: Date.now(),
            task: task,
            time: evTime.getTime(),
            notified: [] // –ú–∞—Å–∏–≤ –¥–ª—è –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏—Ö —ñ–Ω—Ç–µ—Ä–≤–∞–ª—ñ–≤
        });
        localStorage.setItem('v_tasks', JSON.stringify(tasks));
        
        render();
        speak(`–î–æ–±—Ä–µ. –ù–∞–≥–∞–¥–∞—é –ø—Ä–æ ${task} –æ ${timeMatch[1]} ${timeMatch[2]}`);
    } else {
        speak("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å —á–∞—Å, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 15:00");
    }
}

// --- 5. –¢–ê–ô–ú–ï–† –ü–ï–†–ï–í–Ü–†–ö–ò (–ê–í–¢–û–ù–û–ú–ù–ò–ô) ---
setInterval(() => {
    const tasks = JSON.parse(localStorage.getItem('v_tasks') || '[]');
    const now = Date.now();
    let changed = false;

    tasks.forEach(t => {
        const diff = t.time - now;
        const intervals = [
            { ms: 86400000, label: "–∑–∞ –¥–æ–±—É" },
            { ms: 3600000, label: "–∑–∞ –≥–æ–¥–∏–Ω—É" },
            { ms: 300000, label: "–∑–∞ 5 —Ö–≤–∏–ª–∏–Ω" },
            { ms: 0, label: "–ü–û–ß–ê–¢–û–ö" }
        ];

        intervals.forEach((interval, index) => {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ –Ω–∞—Å—Ç–∞–≤ —á–∞—Å —ñ —á–∏ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–∏ –º–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ä–∞–Ω—ñ—à–µ
            if (diff <= interval.ms && diff > (interval.ms - 45000) && !t.notified.includes(index)) {
                const msg = `üîî –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è ${interval.label}: ${t.task}`;
                
                // –í–Ü–î–ü–†–ê–í–ö–ê –ß–ï–†–ï–ó GOOGLE "–ú–Ü–°–¢–û–ö" –£ TELEGRAM
                if (googleBridgeUrl && googleBridgeUrl.startsWith('http')) {
                    fetch(`${googleBridgeUrl}?text=${encodeURIComponent(msg)}`, { mode: 'no-cors' })
                    .catch(() => console.log("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ"));
                }
                
                // –ü—É—à-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –±—Ä–∞—É–∑–µ—Ä—ñ
                if (Notification.permission === "granted") {
                    new Notification(msg);
                }
                
                t.notified.push(index);
                changed = true;
            }
        });
    });

    if (changed) {
        localStorage.setItem('v_tasks', JSON.stringify(tasks));
        render();
    }
}, 30000); // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥

// --- 6. –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –¢–ê –í–ò–î–ê–õ–ï–ù–ù–Ø ---
function render() {
    const tasks = JSON.parse(localStorage.getItem('v_tasks') || '[]');
    const now = Date.now();
    
    // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ñ (—è–∫—ñ —â–µ –Ω–µ –º–∏–Ω—É–ª–∏ –ø–æ–Ω–∞–¥ –≥–æ–¥–∏–Ω—É)
    listEl.innerHTML = tasks
        .filter(t => (now - t.time) < 3600000)
        .sort((a,b) => a.time - b.time)
        .map(t => `
            <div class="item" style="${t.time < now ? 'opacity: 0.6; border-color: #ccc;' : ''}">
                <div>
                    <strong>${t.task}</strong>
                    <small>${new Date(t.time).toLocaleString('uk-UA', {hour: '2-digit', minute:'2-digit', day:'numeric', month:'short'})}</small>
                </div>
                <button class="del-btn" onclick="delT(${t.id})">‚úï</button>
            </div>
        `).join('');
}

window.delT = (id) => {
    let tasks = JSON.parse(localStorage.getItem('v_tasks') || '[]');
    tasks = tasks.filter(t => t.id !== id);
    localStorage.setItem('v_tasks', JSON.stringify(tasks));
    render();
};

// –ó–∞–ø–∏—Ç –ø—Ä–∞–≤ –Ω–∞ –ø—É—à—ñ —Ç–∞ –ø–µ—Ä—à–∏–π —Ä–µ–Ω–¥–µ—Ä
if (Notification.permission !== "granted") {
    Notification.requestPermission();
}
render();

// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è Service Worker –¥–ª—è PWA (—è–∫—â–æ —Ñ–∞–π–ª sw.js —Å—Ç–≤–æ—Ä–µ–Ω–æ)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
