<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –ü–æ–º—ñ—á–Ω–∏–∫ - Cloud</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#007bff">
    
    <style>
        :root { --prm: #007bff; --bg: #f8f9fa; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333; }
        .card { background: var(--card); padding: 30px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 100%; max-width: 420px; text-align: center; }
        #mic-btn { width: 90px; height: 90px; border-radius: 50%; border: none; background: var(--prm); color: white; font-size: 35px; cursor: pointer; transition: all 0.3s ease; margin: 20px 0; box-shadow: 0 5px 20px rgba(0,123,255,0.3); outline: none; }
        #mic-btn.listening { background: #ff4757; transform: scale(1.1); animation: pulse 1.5s infinite; }
        .reminders-list { width: 100%; max-width: 420px; margin-top: 25px; }
        .item { background: white; margin: 12px 0; padding: 18px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--prm); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .del-btn { background: none; border: none; color: #ff4757; font-size: 20px; cursor: pointer; padding: 10px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); } }
    </style>
</head>
<body>

<div class="card">
    <h2>–ú—ñ–π –ü–æ–º—ñ—á–Ω–∏–∫</h2>
    <p id="status">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω</p>
    <button id="mic-btn">üé§</button>
    <div id="output" style="min-height: 1.5em; color: #666; font-style: italic; font-size: 0.9em;"></div>
</div>
<div class="reminders-list" id="list"></div>

<script>
// --- –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø PWA ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
    });
}

// --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ---
const googleBridgeUrl = "https://script.google.com/macros/s/AKfycbw7Z-hOMIAW47y-pZSdT7CgZrMSYCNDs6DM4nBDNa1idu3c8rso0MZ_FLtkSsQ85YEV/exec";

const btn = document.getElementById('mic-btn');
const status = document.getElementById('status');
const output = document.getElementById('output');
const listEl = document.getElementById('list');

// –ì–æ–ª–æ—Å
let ukVoice = null;
const loadVoices = () => {
    ukVoice = window.speechSynthesis.getVoices().find(v => v.lang.startsWith('uk'));
};
window.speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function speak(msg) {
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(msg);
    if (ukVoice) utter.voice = ukVoice;
    utter.lang = 'uk-UA';
    window.speechSynthesis.speak(utter);
}

// –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
if (Speech) {
    const recognition = new Speech();
    recognition.lang = 'uk-UA';
    
    btn.onclick = () => { try { recognition.start(); } catch (e) {} };
    recognition.onstart = () => { btn.classList.add('listening'); status.innerText = "–Ø —Å–ª—É—Ö–∞—é..."; };
    recognition.onend = () => { btn.classList.remove('listening'); status.innerText = "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω"; };
    recognition.onresult = (e) => {
        const text = e.results[0][0].transcript.toLowerCase();
        output.innerText = `¬´${text}¬ª`;
        parseText(text);
    };
}

// --- –ù–û–í–ê –õ–û–ì–Ü–ö–ê –•–ú–ê–†–ù–ò–• –ù–ê–ì–ê–î–£–í–ê–ù–¨ ---
function parseText(text) {
    const timeMatch = text.match(/(\d{1,2})[:.\s](\d{2})/);
    if (timeMatch) {
        const now = new Date();
        let evTime = new Date(now);
        evTime.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]), 0);
        
        if (evTime < now) evTime.setDate(evTime.getDate() + 1);
        
        // –í–∏—Ä–∞—Ö–æ–≤—É—î–º–æ —Ä—ñ–∑–Ω–∏—Ü—é –≤ —Ö–≤–∏–ª–∏–Ω–∞—Ö
        const diffMs = evTime.getTime() - now.getTime();
        const diffMinutes = Math.floor(diffMs / 60000);
        
        if (diffMinutes < 0) { speak("–¶–µ–π —á–∞—Å —É–∂–µ –º–∏–Ω—É–≤"); return; }

        const task = text.replace(/–Ω–∞–≥–∞–¥–∞–π|–º–µ–Ω—ñ|–ø—Ä–æ|–æ|–≤|–Ω–∞|–∑–∞–ø–∏—à–∏/g, '').trim() || "–ü–æ–¥—ñ—è";
        
        // –í–Ü–î–ü–†–ê–í–õ–Ø–Ñ–ú–û –í GOOGLE CLOUD
        const url = `${googleBridgeUrl}?text=${encodeURIComponent(task)}&diff=${diffMinutes}`;
        fetch(url, { mode: 'no-cors' });

        speak(`–î–æ–±—Ä–µ. –ù–∞–≥–∞–¥–∞—é –ø—Ä–æ ${task} —á–µ—Ä–µ–∑ ${diffMinutes} —Ö–≤–∏–ª–∏–Ω`);
        
        // –î–æ–¥–∞—î–º–æ –≤ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
        const tasks = JSON.parse(localStorage.getItem('v_tasks') || '[]');
        tasks.push({ id: Date.now(), task, time: evTime.getTime() });
        localStorage.setItem('v_tasks', JSON.stringify(tasks));
        render();
    } else {
        speak("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å —á–∞—Å, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 12:45");
    }
}

// –†–µ–Ω–¥–µ—Ä —Ç–∞ –∞–≤—Ç–æ–≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –∑ –µ–∫—Ä–∞–Ω–∞
setInterval(() => {
    let tasks = JSON.parse(localStorage.getItem('v_tasks') || '[]');
    const now = Date.now();
    const newTasks = tasks.filter(t => (now - t.time) < 1800000); // –≤–∏–¥–∞–ª—è—î–º–æ —á–µ—Ä–µ–∑ 30 —Ö–≤ –ø—ñ—Å–ª—è –ø–æ–¥—ñ—ó
    if (newTasks.length !== tasks.length) {
        localStorage.setItem('v_tasks', JSON.stringify(newTasks));
        render();
    }
}, 60000);

function render() {
    const tasks = JSON.parse(localStorage.getItem('v_tasks') || '[]');
    listEl.innerHTML = tasks.sort((a,b) => a.time - b.time).map(t => `
        <div class="item" style="${t.time < Date.now() ? 'opacity: 0.5;' : ''}">
            <div><strong>${t.task}</strong><small>${new Date(t.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small></div>
            <button class="del-btn" onclick="delT(${t.id})">‚úï</button>
        </div>
    `).join('');
}

window.delT = (id) => {
    const tasks = JSON.parse(localStorage.getItem('v_tasks') || '[]').filter(t => t.id !== id);
    localStorage.setItem('v_tasks', JSON.stringify(tasks));
    render();
};

render();
</script>
</body>
</html>
